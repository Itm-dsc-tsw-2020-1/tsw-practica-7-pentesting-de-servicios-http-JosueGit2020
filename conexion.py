import sqlite3
import requests


def get_http_hosts():
    '''Gets all the hosts in the database which have http service running'''

    c = sqlite3.connect('services.db')
    rows = c.execute(
        'SELECT host FROM ports_info WHERE service = "http"').fetchall()
    c.close()

    return [row[0] for row in rows]


def request_hosts(hosts, messages):
    '''Requests the given hosts and returns a dictionary with host ips as keys
    and HTML text as value'''

    successfully_requested_hosts = {}

    for host in hosts:
        try:
            response = requests.get(f'http://{host}/')
        except:
            if messages:
                print(f'There was a problem when trying to request "{host}"')
            continue

        if response.status_code == requests.codes.ok:
            successfully_requested_hosts[host] = response.text
            if messages:
                print(f'Successful request to "{host}"')
        else:
            if messages:
                print(f'Unsuccessful request to "{host}"')

    return successfully_requested_hosts


def getHostsContent(messages):
    '''Gets the hosts from the database and the returns a dictionary with the
    hosts ips as keys and the the HTML text as values'''

    hosts = get_http_hosts()
    successfully_requested_hosts = request_hosts(hosts, messages)
    return successfully_requested_hosts


if __name__ == '__main__':
    successfully_requested_hosts = getHostsContent(True)
